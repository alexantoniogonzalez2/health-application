(function(){
  angular.module('endodonticApp', ['templates', 'ng-rails-csrf', 'ui.select'])
    .controller('GeneralEndodonticController', ['$http','$filter', '$scope', '$timeout', function($http, $filter,$scope,$timeout) {  

      $scope.general = this;      
      $scope.general.tooths = [];
      $http.get('/load_odontogram', { params: { atencion_salud_id: atencion_salud_id, tipo: 'default' } }).success(function(data){
        $scope.general.tooths = data;
      });
      $scope.general.diagnosis = []; 
      $http.get('/load_diagnosis', { params: { atencion_salud_id: atencion_salud_id} }).success(function(data){
        $scope.general.diagnosis = data;
      });
      $scope.itemArray = [
        {id: 1, name: 'Pulpitis reversible'},
        {id: 2, name: 'Pulpitis irreversible aguda (sintomática)'},
        {id: 3, name: 'Pulpitis reversible crónica (asintomática)'},
        {id: 4, name: 'Pulpitis hiperclásica (polipo pulpar)'},
        {id: 5, name: 'Reabsorción dentinaria interna'},
        {id: 6, name: 'Calcificación pulpar'},
        {id: 7, name: 'Necrosis pulpar'},
      ];
      $scope.endo = this;
      $http.get('/load_endodontic', { params: { atencion_salud_id: atencion_salud_id} }).success(function(data){
        $scope.endo = data;
        $scope.selected = { value: $scope.itemArray[$scope.endo.diag-1] };
      });

      var timeout = null;
      var saveUpdate = function(parameterName,newValue) {
        if (parameterName == 'selected'){

        }
        if (parameterName == 'diagnosis'){

        } else {
          
        }

        console.log(parameterName + ' :' + newValue);
        // .... save data to server

      };
      var debounceSaveUpdates = function(parameterName,newValue) {
        if (timeout) { $timeout.cancel(timeout); }
        timeout = $timeout(function(){
          saveUpdate(parameterName,newValue);
        },2000); 
      };

      $scope.$watch('endo.com_dolor', function (newValue, oldValue) { saveUpdate('com_dolor', newValue); });
      $scope.$watch('endo.dolor', function (newValue, oldValue) { saveUpdate('dolor', newValue); });
      $scope.$watch('endo.inten', function (newValue, oldValue) { saveUpdate('inten', newValue); });
      $scope.$watch('endo.carac1', function (newValue, oldValue) { saveUpdate('carac1', newValue); });
      $scope.$watch('endo.carac2', function (newValue, oldValue) { saveUpdate('carac2', newValue); });
      $scope.$watch('endo.carac3', function (newValue, oldValue) { saveUpdate('carac3', newValue); });
      $scope.$watch('endo.carac4', function (newValue, oldValue) { saveUpdate('carac4', newValue); });
      $scope.$watch('endo.estim1', function (newValue, oldValue) { saveUpdate('estim1', newValue); });
      $scope.$watch('endo.estim2', function (newValue, oldValue) { saveUpdate('estim2', newValue); });
      $scope.$watch('endo.estim3', function (newValue, oldValue) { saveUpdate('estim3', newValue); });
      $scope.$watch('endo.estim4', function (newValue, oldValue) { saveUpdate('estim4', newValue); });
      $scope.$watch('selected.value', function (newValue, oldValue) { saveUpdate('selected', newValue); });
      $scope.$watch('endo.inf_adi', function (newValue, oldValue) { debounceSaveUpdates('inf_adi', newValue); });
      $scope.$watch('endo.exa_ext', function (newValue, oldValue) { debounceSaveUpdates('exa_ext', newValue); });
      $scope.$watch('endo.exa_int', function (newValue, oldValue) { debounceSaveUpdates('exa_int', newValue); });
      $scope.$watch('endo.exa_rad', function (newValue, oldValue) { debounceSaveUpdates('exa_rad', newValue); });
      $scope.$watch('endo.com_endodoncia', function (newValue, oldValue) { debounceSaveUpdates('com_endodoncia', newValue); });
      $scope.$watch('general.diagnosis', function (newValue, oldValue) { debounceSaveUpdates('diagnosis', newValue); },true);
      
      this.selectTooth = function(event) {  
        var id = angular.element(event.target).parent().parent().parent().parent().parent().parent()[0]['id'];
        var new_id = angular.element(event.target)[0]['id'];

        if (id.match("^pieza_dental_") ){
          tooth = $filter('filter')($scope.general.tooths, function (d) {return d.name === new_id;})[0];
          $scope.endo.name = new_id;
          $scope.endo.descripcion = tooth.descripcion;
          $scope.endo.image ="/assets/dental/od_"+new_id[0]+"/"+new_id+".jpg";
          $( "#tooltip_endodoncia" ).hide();

        } else {
          diag = $filter('filter')($scope.general.diagnosis, function (d) {return d.name === id;})[0];
          diag.name = new_id;
          diag.image = "/assets/dental/od_"+new_id[0]+"/"+new_id+".jpg";
          $( "#tooltip_test" ).hide();
        }
      };
      this.deleteTest = function(item) {  
        $("#test-aux").append($( "#tooltip_test"));
        var index = $scope.general.diagnosis.indexOf(item);
        $scope.general.diagnosis.splice(index, 1);
      };
      this.addTest = function() { 
        test = $filter('filter')($scope.general.diagnosis, function (d) {return d.name === '';})[0];
        if (test == null){
          var tooth = {
            name: '',
            image: "/assets/dental/otros/blank.jpg",
            calor: 4,
            electrico: 4,
            percusion: 4,
            palpacion: 4,
            observacion: ""
          };
          $scope.general.diagnosis.push(tooth);          
        }
        else {
          alert('Seleccione una pieza dental para agregar más pruebas.');
        }
      };
      this.showTooltipEnd = function(event,tooltip) {
        $( "#"+tooltip ).addClass('flex');
        $( "#"+tooltip ).removeClass('hidden');
        $( "#"+tooltip ).show(); 
        angular.element(event.target).parent().append($( "#"+tooltip ));
      };
    }])
    .directive('diagnosisTest', function(){ 
      return {
        restrict: 'E',
        templateUrl: 'diagnosis-test.html'
      }; 
    })
    .directive('diagnosisTestPanel', ['$filter',function($filter){ 
      return {
        restrict: 'E',
        scope: {
          valor: '=',
          tipo: '=',
          name: '=',
          general: '=',
          tagFilter: '=filter'
        },
        templateUrl: 'diagnosis-test-panel.html',
        link: function(scope, element, attrs) {
                scope.setTest = function(tipo,valor,name,general) {
                  var found = $filter('filter')(general.diagnosis, {name: name}, true);
                  found[0][tipo] = valor;
                };
            }        
      }; 
    }])
    .directive('tooltipEndodoncia', function(){ 
      return {
        restrict: 'E',
        templateUrl: 'tooltip-endodoncia.html'
      }; 
    })
    .directive('endodonciaSeleccion', function(){ 
      return {
        restrict: 'E',
        templateUrl: 'endodoncia-seleccion.html'
      }; 
    });

  angular.element("#endodontic").ready(function() {
    angular.bootstrap("#endodontic", ['endodonticApp']);
  });

})();
